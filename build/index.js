/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var t=function(e,o){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])})(e,o)};function e(e,o){if("function"!=typeof o&&null!==o)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}var o=function(){return(o=Object.assign||function(t){for(var e,o=1,i=arguments.length;o<i;o++)for(var n in e=arguments[o])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function i(t){var e="function"==typeof Symbol&&Symbol.iterator,o=e&&t[e],i=0;if(o)return o.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function n(t,e){var o="function"==typeof Symbol&&t[Symbol.iterator];if(!o)return t;var i,n,r=o.call(t),l=[];try{for(;(void 0===e||e-- >0)&&!(i=r.next()).done;)l.push(i.value)}catch(t){n={error:t}}finally{try{i&&!i.done&&(o=r.return)&&o.call(r)}finally{if(n)throw n.error}}return l}function r(t,e){for(var o=0,i=e.length,n=t.length;o<i;o++,n++)t[n]=e[o];return t}var l,u=function(){function t(t,e){this.spriteX=0,this.spriteY=0,this.spriteHeight=45,this.spriteWidth=45;var o=n(this.setSpriteCoordinates(t,e),2),i=o[0],r=o[1];this.spriteX=null!=i?i:0,this.spriteY=null!=r?r:0}return t.prototype.serialize=function(){return[this.spriteX,this.spriteY,this.spriteWidth,this.spriteHeight]},t.prototype.setSpriteCoordinates=function(t,e){var o="White"===e?0:45;switch(t){case"King":return[0,o];case"Queen":return[45,o];case"Bishop":return[90,o];case"Knight":return[135,o];case"Rook":return[180,o];case"Pawn":return[225,o]}},t}(),a=new Uint8Array(16);function s(){if(!l&&!(l="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return l(a)}var h=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function f(t){return"string"==typeof t&&h.test(t)}for(var c=[],g=0;g<256;++g)c.push((g+256).toString(16).substr(1));function d(t,e,o){var i=(t=t||{}).random||(t.rng||s)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,e){o=o||0;for(var n=0;n<16;++n)e[o+n]=i[n];return e}return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=(c[t[e+0]]+c[t[e+1]]+c[t[e+2]]+c[t[e+3]]+"-"+c[t[e+4]]+c[t[e+5]]+"-"+c[t[e+6]]+c[t[e+7]]+"-"+c[t[e+8]]+c[t[e+9]]+"-"+c[t[e+10]]+c[t[e+11]]+c[t[e+12]]+c[t[e+13]]+c[t[e+14]]+c[t[e+15]]).toLowerCase();if(!f(o))throw TypeError("Stringified UUID is invalid");return o}(i)}var v,p=function(){function t(t,e){this.id=d(),this.name=t,this.color=e,this.visuals=new u(t,e)}return t.prototype.getColor=function(){return this.color},t.prototype.getName=function(){return this.name},t.prototype.getVisuals=function(){return this.visuals},t.prototype.getId=function(){return this.id},t}(),b=function(t){function o(e){return t.call(this,"Bishop",e)||this}return e(o,t),o}(p);!function(t){t.Linear="Linear",t.Simple="Simple"}(v||(v={}));var y,m,N=function(){function t(){}return t.prototype.make=function(t,e,o){var i,l,u=null===(i=t.getFieldByNotation(e))||void 0===i?void 0:i.getFigure(),a=null===(l=t.getFieldByNotation(o))||void 0===l?void 0:l.getFigure();return u?r(r([],n(a?[{from:o,to:null,figure:a}]:[])),[{from:e,to:o,figure:u}]):[]},t}(),w=function(t){function o(){var e=null!==t&&t.apply(this,arguments)||this;return e.type=v.Simple,e}return e(o,t),o.prototype.checkAttackable=function(t){var e,o,n=[];try{for(var r=i(t),l=r.next();!l.done;l=r.next()){var u=l.value;u&&n.push(u)}}catch(t){e={error:t}}finally{try{l&&!l.done&&(o=r.return)&&o.call(r)}finally{if(e)throw e.error}}return n},o.prototype.checkMovable=function(t,e,o){var n,r,l,u,a=[],s=e.getFieldByNotation(t);try{for(var h=i(o),f=h.next();!f.done;f=h.next()){var c=f.value;if(c){var g=e.getFieldByNotation(c);(null==g?void 0:g.getFigure())&&(null===(l=null==g?void 0:g.getFigure())||void 0===l?void 0:l.getColor())===(null===(u=null==s?void 0:s.getFigure())||void 0===u?void 0:u.getColor())||a.push(c)}}}catch(t){n={error:t}}finally{try{f&&!f.done&&(r=h.return)&&r.call(h)}finally{if(n)throw n.error}}return a},o}(N),F=function(t){function o(){var e=null!==t&&t.apply(this,arguments)||this;return e.type=v.Linear,e}return e(o,t),o.prototype.iterateMovable=function(t,e,o){for(var i,n,r=t.getFieldByNotation(e),l=[],u=o(e),a=u&&t.getFieldByNotation(u);u&&a&&!a.getFigure();)l.push(u),a=(u=o(u))&&t.getFieldByNotation(u);return u&&a&&(null===(i=a.getFigure())||void 0===i?void 0:i.getColor())!==(null===(n=null==r?void 0:r.getFigure())||void 0===n?void 0:n.getColor())&&l.push(u),l},o.prototype.iterateAttackable=function(t,e,o){for(var i=[],n=o(e),r=n&&t.getFieldByNotation(n);n&&r&&!r.getFigure();)i.push(n),r=(n=o(n))&&t.getFieldByNotation(n);return n&&r&&i.push(n),i},o}(N),k=function(){function t(){}return t.toNotation=function(t,e){var o,i,n=null===(o=this.colNotation)||void 0===o?void 0:o[e],r=null===(i=this.rowNotation)||void 0===i?void 0:i[t];return n&&r?n+r:null},t.fromNotation=function(t){var e=n(t.split(""),2),o=e[0],i=e[1];return i&&o?[this.rowNotation.indexOf(i),this.colNotation.indexOf(o)]:[0,0]},t.rowNotation=["8","7","6","5","4","3","2","1"],t.colNotation=["a","b","c","d","e","f","g","h"],t}(),B=function(){function t(){}return t.measureLengthOfMove=function(t,e){var o=n(k.fromNotation(t),2),i=o[0],r=o[1],l=n(k.fromNotation(e),2),u=n([i-l[0],r-l[1]],2),a=u[0],s=u[1];return Math.sqrt(Math.pow(a,2)+Math.pow(s,2))},t}(),P=function(){function t(){}return t.topNeighbour=function(e){return t.useNotation(e,[-1,0])},t.bottomNeighbour=function(e){return t.useNotation(e,[1,0])},t.leftNeighbour=function(e){return t.useNotation(e,[0,-1])},t.rightNeighbour=function(e){return t.useNotation(e,[0,1])},t.topLeftNeighbour=function(e){return t.useNotation(e,[-1,-1])},t.topRightNeighbour=function(e){return t.useNotation(e,[-1,1])},t.bottomLeftNeighbour=function(e){return t.useNotation(e,[1,-1])},t.bottomRightNeighbour=function(e){return t.useNotation(e,[1,1])},t.topLeftKnightNeighbour=function(e){return t.useNotation(e,[-2,-1])},t.topRightKnightNeighbour=function(e){return t.useNotation(e,[-2,1])},t.leftTopKnightNeighbour=function(e){return t.useNotation(e,[-1,-2])},t.leftBottomKnightNeighbour=function(e){return t.useNotation(e,[1,-2])},t.bottomLeftKnightNeighbour=function(e){return t.useNotation(e,[2,-1])},t.bottomRightKnightNeighbour=function(e){return t.useNotation(e,[2,1])},t.rightBottomKnightNeighbour=function(e){return t.useNotation(e,[1,2])},t.rightTopKnightNeighbour=function(e){return t.useNotation(e,[-1,2])},t.useNotation=function(t,e){var o=n(k.fromNotation(t),2),i=o[0],r=o[1];return k.toNotation(i+e[0],r+e[1])},t}(),M=function(){function t(){}return t.toIndex=function(t,e,o,i){return[Math.floor(e/i),Math.floor(t/o)]},t.fromIndex=function(t,e,o,i){return[e*o,t*i]},t}(),C=function(){function t(){}return t.convert=function(t){return"White"===t?"Black":"White"},t}(),R=function(t){function o(){return null!==t&&t.apply(this,arguments)||this}return e(o,t),o.prototype.canAttackTo=function(t,e){return r(r(r(r([],n(this.iterateAttackable(t,e,P.topLeftNeighbour))),n(this.iterateAttackable(t,e,P.topRightNeighbour))),n(this.iterateAttackable(t,e,P.bottomLeftNeighbour))),n(this.iterateAttackable(t,e,P.bottomRightNeighbour)))},o.prototype.canMoveTo=function(t,e){return r(r(r(r([],n(this.iterateMovable(t,e,P.topLeftNeighbour))),n(this.iterateMovable(t,e,P.topRightNeighbour))),n(this.iterateMovable(t,e,P.bottomLeftNeighbour))),n(this.iterateMovable(t,e,P.bottomRightNeighbour)))},o}(F),W=function(t){function o(e){return t.call(this,"King",e)||this}return e(o,t),o}(p),A=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i.prototype.make=function(t,e,o){var i,r,l,u=B.measureLengthOfMove(e,o),a=null===(i=t.getFieldByNotation(e))||void 0===i?void 0:i.getFigure();if(!a)return[];if(2!==u){var s=null===(r=t.getFieldByNotation(o))||void 0===r?void 0:r.getFigure();return s?[{from:o,to:null,figure:s},{from:e,to:o,figure:a}]:[{from:e,to:o,figure:a}]}var h=n(k.fromNotation(e),2)[1]-n(k.fromNotation(o),2)[1],f=a.getColor(),c=h<0,g=c?"White"===f?"h1":"h8":"White"===f?"a1":"a8",d=c?"White"===f?"f1":"f8":"White"===f?"d1":"d8",v=null===(l=t.getFieldByNotation(g))||void 0===l?void 0:l.getFigure();return v?[{from:e,to:o,figure:a},{from:g,to:d,figure:v}]:[]},i.prototype.canAttackTo=function(t,e){return this.checkAttackable([P.topLeftNeighbour(e),P.topNeighbour(e),P.topRightNeighbour(e),P.leftNeighbour(e),P.bottomLeftNeighbour(e),P.bottomNeighbour(e),P.bottomRightNeighbour(e),P.rightNeighbour(e)])},i.prototype.canMoveTo=function(t,e,i,l){var u,a=null===(u=t.getFieldByNotation(e))||void 0===u?void 0:u.getFigure();if(!a)return[];var s=this.checkMovable(e,t,[P.topLeftNeighbour(e),P.topNeighbour(e),P.topRightNeighbour(e),P.leftNeighbour(e),P.bottomLeftNeighbour(e),P.bottomNeighbour(e),P.bottomRightNeighbour(e),P.rightNeighbour(e)]),h=Boolean(i.filter({id:a.getId()}).length),f=l.isAttacked(t,e,C.convert(a.getColor()));if(h||f)return s;var c=i.filter({name:"Rook",color:a.getColor()}).reduce((function(t,e){var i,l,u;return e.id?t[e.id]?o(o({},t),((i={})[e.id]=r(r([],n(null!==(u=t[e.id])&&void 0!==u?u:[])),[e]),i)):o(o({},t),((l={})[e.id]=[e],l)):t}),{});if(2===Object.keys(c).length)return s;var g=Array.from({length:3}).reduce((function(t,o,i){var l;return r(r([],n(t)),[P.rightNeighbour(null!==(l=null==t?void 0:t[i-1])&&void 0!==l?l:e)])}),[]),d=Array.from({length:4}).reduce((function(t,o,i){var l;return r(r([],n(t)),[P.leftNeighbour(null!==(l=null==t?void 0:t[i-1])&&void 0!==l?l:e)])}),[]),v=function(e,o,i,n){var r,u,s,h=i===n.length-1,f=4===n.length&&2===i,g=!(null===(r=t.getFieldByNotation(o))||void 0===r?void 0:r.getFigure()),d=l.isAttacked(t,o,C.convert(a.getColor()));if(!h)return f?e&&g:e&&g&&!d;var v=null===(s=null===(u=t.getFieldByNotation(o))||void 0===u?void 0:u.getFigure())||void 0===s?void 0:s.getId();if(!v)return!1;var p=Boolean(c[v]);return e&&!p},p=g.reduce(v,!0),b=d.reduce(v,!0),y=[];return p&&g[1]&&y.push(g[1]),b&&d[1]&&y.push(d[1]),r(r([],n(s)),n(y))},i}(w),L=function(t){function o(e){return t.call(this,"Knight",e)||this}return e(o,t),o}(p),S=function(t){function o(){return null!==t&&t.apply(this,arguments)||this}return e(o,t),o.prototype.canAttackTo=function(t,e){return this.checkAttackable([P.topLeftKnightNeighbour(e),P.topRightKnightNeighbour(e),P.leftTopKnightNeighbour(e),P.leftBottomKnightNeighbour(e),P.bottomLeftKnightNeighbour(e),P.bottomRightKnightNeighbour(e),P.rightBottomKnightNeighbour(e),P.rightTopKnightNeighbour(e)])},o.prototype.canMoveTo=function(t,e){return this.checkMovable(e,t,[P.topLeftKnightNeighbour(e),P.topRightKnightNeighbour(e),P.leftTopKnightNeighbour(e),P.leftBottomKnightNeighbour(e),P.bottomLeftKnightNeighbour(e),P.bottomRightKnightNeighbour(e),P.rightBottomKnightNeighbour(e),P.rightTopKnightNeighbour(e)])},o}(w),x=function(t){function o(e){return t.call(this,"Pawn",e)||this}return e(o,t),o}(p),K=function(t){function o(e){return t.call(this,"Queen",e)||this}return e(o,t),o}(p),T=function(t){function o(){return null!==t&&t.apply(this,arguments)||this}return e(o,t),o.prototype.make=function(t,e,o){var i,r,l,u,a=null===(i=t.getFieldByNotation(e))||void 0===i?void 0:i.getFigure(),s=null===(r=t.getFieldByNotation(o))||void 0===r?void 0:r.getFigure();if(!a)return[];var h=n(k.fromNotation(e),2)[1],f=n(k.fromNotation(o),2),c=f[0],g=f[1];if(0===c||7===c)return s?[{from:o,to:null,figure:s},{from:e,to:null,figure:a},{from:null,to:o,figure:new K(a.getColor())}]:[{from:e,to:null,figure:a},{from:null,to:o,figure:new K(a.getColor())}];if(s)return[{from:o,to:null,figure:s},{from:e,to:o,figure:a}];if(h===g)return[{from:e,to:o,figure:a}];var d=P.bottomNeighbour(o);if("White"===a.getColor()&&d)return(v=null===(l=t.getFieldByNotation(d))||void 0===l?void 0:l.getFigure())?[{from:e,to:o,figure:a},{from:d,to:null,figure:v}]:[];var v,p=P.topNeighbour(o);return"Black"===a.getColor()&&p&&(v=null===(u=t.getFieldByNotation(p))||void 0===u?void 0:u.getFigure())?[{from:e,to:o,figure:a},{from:p,to:null,figure:v}]:[]},o.prototype.canAttackTo=function(t,e){var o,i=null===(o=t.getFieldByNotation(e))||void 0===o?void 0:o.getFigure();if(!i)return[];var r=n("White"===i.getColor()?[P.topLeftNeighbour,P.topRightNeighbour]:[P.bottomLeftNeighbour,P.bottomRightNeighbour],2),l=r[0],u=r[1],a=[],s=l(e);s&&a.push(s);var h=u(e);return h&&a.push(h),a},o.prototype.canMoveTo=function(t,e,o){var i,l,u,a=null===(i=t.getFieldByNotation(e))||void 0===i?void 0:i.getFigure();if(!a)return[];var s="White"===a.getColor()?P.topNeighbour:P.bottomNeighbour,h=n("White"===a.getColor()?[P.topLeftNeighbour,P.topRightNeighbour]:[P.bottomLeftNeighbour,P.bottomRightNeighbour],2),f=h[0],c=h[1],g=[],d=s(e);d&&!(null===(l=t.getFieldByNotation(d))||void 0===l?void 0:l.getFigure())&&g.push(d);var v=Boolean(o.filter({id:a.getId()}).length),p=d&&g.includes(d)&&s(d);v||!p||(null===(u=t.getFieldByNotation(p))||void 0===u?void 0:u.getFigure())||g.push(p);var b=function(e){var o,i;return(null===(i=null===(o=t.getFieldByNotation(e))||void 0===o?void 0:o.getFigure())||void 0===i?void 0:i.getColor())===C.convert(a.getColor())},y=f(e);y&&b(y)&&g.push(y);var m=c(e);m&&b(m)&&g.push(m);var N=o.getLastMove();if(!N)return g;if(!(N.specials.pawnLongMove&&N.color===C.convert(a.getColor()))||!N.toPosition)return g;var w=n(k.fromNotation(e),2),F=w[0],B=w[1],M=n(k.fromNotation(N.toPosition),2),R=M[0],W=M[1];if(F!==R||1!==Math.abs(B-W))return g;var A=P.topNeighbour(N.toPosition),L=P.bottomNeighbour(N.toPosition);return"White"===a.getColor()&&A?r(r([],n(g)),[A]):"Black"===a.getColor()&&L?r(r([],n(g)),[L]):g},o}(w),E=function(t){function o(){return null!==t&&t.apply(this,arguments)||this}return e(o,t),o.prototype.canAttackTo=function(t,e){return r(r(r(r(r(r(r(r([],n(this.iterateAttackable(t,e,P.topNeighbour))),n(this.iterateAttackable(t,e,P.topLeftNeighbour))),n(this.iterateAttackable(t,e,P.leftNeighbour))),n(this.iterateAttackable(t,e,P.bottomLeftNeighbour))),n(this.iterateAttackable(t,e,P.bottomNeighbour))),n(this.iterateAttackable(t,e,P.bottomRightNeighbour))),n(this.iterateAttackable(t,e,P.rightNeighbour))),n(this.iterateAttackable(t,e,P.topRightNeighbour)))},o.prototype.canMoveTo=function(t,e){return r(r(r(r(r(r(r(r([],n(this.iterateMovable(t,e,P.topNeighbour))),n(this.iterateMovable(t,e,P.topLeftNeighbour))),n(this.iterateMovable(t,e,P.leftNeighbour))),n(this.iterateMovable(t,e,P.bottomLeftNeighbour))),n(this.iterateMovable(t,e,P.bottomNeighbour))),n(this.iterateMovable(t,e,P.bottomRightNeighbour))),n(this.iterateMovable(t,e,P.rightNeighbour))),n(this.iterateMovable(t,e,P.topRightNeighbour)))},o}(F),I=function(t){function o(e){return t.call(this,"Rook",e)||this}return e(o,t),o}(p),O=function(t){function o(){return null!==t&&t.apply(this,arguments)||this}return e(o,t),o.prototype.canAttackTo=function(t,e){return r(r(r(r([],n(this.iterateAttackable(t,e,P.topNeighbour))),n(this.iterateAttackable(t,e,P.leftNeighbour))),n(this.iterateAttackable(t,e,P.bottomNeighbour))),n(this.iterateAttackable(t,e,P.rightNeighbour)))},o.prototype.canMoveTo=function(t,e){return r(r(r(r([],n(this.iterateMovable(t,e,P.topNeighbour))),n(this.iterateMovable(t,e,P.leftNeighbour))),n(this.iterateMovable(t,e,P.rightNeighbour))),n(this.iterateMovable(t,e,P.bottomNeighbour)))},o}(F),V=function(t){var e,o,i,n,r,l,u;this.defaultLayout={a1:new I("White"),b1:new L("White"),c1:new b("White"),e1:new W("White"),d1:new K("White"),f1:new b("White"),g1:new L("White"),h1:new I("White"),a2:new x("White"),b2:new x("White"),c2:new x("White"),d2:new x("White"),e2:new x("White"),f2:new x("White"),g2:new x("White"),h2:new x("White"),a8:new I("Black"),b8:new L("Black"),c8:new b("Black"),d8:new K("Black"),e8:new W("Black"),f8:new b("Black"),g8:new L("Black"),h8:new I("Black"),a7:new x("Black"),b7:new x("Black"),c7:new x("Black"),d7:new x("Black"),e7:new x("Black"),f7:new x("Black"),g7:new x("Black"),h7:new x("Black")},this.layout=this.defaultLayout,this.defaultMovements={Bishop:new R,King:new A,Queen:new E,Pawn:new T,Rook:new O,Knight:new S},this.movements=this.defaultMovements,this.fieldRows=8,this.fieldCols=8,this.figuresSpritePath="/figures/sprite.svg",this.inevitablePlan={White:new Array,Black:new Array},this.followablePlan={White:new Array,Black:new Array},"BoardRules"===t.type&&(this.layout=null!==(e=t.layout)&&void 0!==e?e:this.defaultLayout,this.movements=null!==(o=t.movements)&&void 0!==o?o:this.defaultMovements),"BoardState"===t.type&&(this.fieldRows=null!==(i=t.fieldRows)&&void 0!==i?i:8,this.fieldCols=null!==(n=t.fieldCols)&&void 0!==n?n:8),"BoardRenderer"===t.type&&(this.figuresSpritePath=null!==(r=t.figuresSpritePath)&&void 0!==r?r:"/figures/sprite.svg"),"BoardTime"===t.type&&(this.inevitablePlan=null!==(l=t.inevitablePlan)&&void 0!==l?l:{White:[],Black:[]},this.followablePlan=null!==(u=t.followablePlan)&&void 0!==u?u:{White:[],Black:[]})},H=function(t){this.data=new V({type:"BoardRenderer",figuresSpritePath:null==t?void 0:t.figuresSpritePath})},j=function(t){var e,o,i,n;this.onPlanContinuance=function(){return null},this.onPlanViolation=function(){return null},this.onEnd=function(){return null},this.onMove=function(){return null},"BoardTime"===t.type&&(this.onPlanContinuance=null!==(e=t.onPlanContinuance)&&void 0!==e?e:function(){return null},this.onPlanViolation=null!==(o=t.onPlanViolation)&&void 0!==o?o:function(){return null}),"BoardRules"===t.type&&(this.onEnd=null!==(i=t.onEnd)&&void 0!==i?i:function(){return null},this.onMove=null!==(n=t.onMove)&&void 0!==n?n:function(){return null})},z=function(t){var e,o;this.shouldEndOnPlanViolation=!0,this.shouldEnforcePlan=!0,"BoardRules"===t.type&&(this.shouldEndOnPlanViolation=null===(e=null==t?void 0:t.shouldEndOnPlanViolation)||void 0===e||e,this.shouldEnforcePlan=null===(o=null==t?void 0:t.shouldEnforcePlan)||void 0===o||o)},_=function(t){this.listeners=new j({type:"BoardRules",onEnd:null==t?void 0:t.onEnd}),this.switches=new z({type:"BoardRules",shouldEndOnPlanViolation:null==t?void 0:t.shouldEndOnPlanViolation,shouldEnforcePlan:null==t?void 0:t.shouldEnforcePlan}),this.data=new V({type:"BoardRules",layout:null==t?void 0:t.layout,movements:null==t?void 0:t.movements})},X=function(t){this.data=new V({type:"BoardState",fieldRows:null==t?void 0:t.fieldRows,fieldCols:null==t?void 0:t.fieldCols})},Y=function(){function t(t,e,i){this.specials={capture:!1,pawnLongMove:!1,pawnEnPassant:!1,castleLong:!1,castleShort:!1,promotion:null},this.fromPosition=t[0],this.toPosition=t[1],this.color=e.color,this.name=e.name,this.id=e.id,this.specials=o(o({},this.specials),i)}return t.prototype.equals=function(t){return t.fromPosition===this.fromPosition&&t.toPosition===this.toPosition&&t.color===this.color&&t.name===this.name&&t.specials.promotion===this.specials.promotion},t}(),q=function(){function t(t){this.data=new V({type:"BoardTime",inevitablePlan:this.deserializePlan(null==t?void 0:t.inevitablePlan),followablePlan:this.deserializePlan(null==t?void 0:t.followablePlan)}),this.listeners=new j({type:"BoardTime",onPlanContinuance:null==t?void 0:t.onPlanContinuance,onPlanViolation:null==t?void 0:t.onPlanViolation})}return t.prototype.deserializePlan=function(t){if(!t)return{White:[],Black:[]};var e=function(t){return t.map((function(t){return new Y([t.from,t.to],{color:t.color,name:t.name,id:null},t)}))};return{White:e(t.White),Black:e(t.Black)}},t}(),D=function(t){this.rules=new _(null==t?void 0:t.rules),this.time=new q(null==t?void 0:t.time),this.state=new X(null==t?void 0:t.state),this.renderer=new H(null==t?void 0:t.renderer)};!function(t){t.Idle="Idle",t.Selected="Selected",t.Playable="Playable"}(y||(y={})),function(t){t.White="White",t.Black="Black"}(m||(m={}));var Q=function(){function t(t){this.figure=null,this.state=y.Idle,this.color=t}return t.prototype.getFigure=function(){return this.figure},t.prototype.setFigure=function(t){this.figure=t},t.prototype.getColor=function(){switch(this.state){case y.Idle:return this.color===m.White?"#FBFAF8":"#804E49";case y.Selected:return"#5A914D";case y.Playable:return"#8FAD88"}},t.prototype.getState=function(){return this.state},t.prototype.setState=function(t){this.state=t},t}(),U=function(t){function o(){return t.call(this,m.White)||this}return e(o,t),o}(Q),G=function(t){function o(){return t.call(this,m.Black)||this}return e(o,t),o}(Q),$=function(){function t(t){this.canvasHeight=t.height,this.canvasWidth=t.width}return t.prototype.onClick=function(t,e,o,i){var r=n(t,2),l=r[0],u=r[1],a=n(M.toIndex(l,u,this.canvasWidth/8,this.canvasHeight/8),2),s=a[0],h=a[1],f=k.toNotation(s,h);if(f){var c=e.getFieldByNotation(f);switch(null==c?void 0:c.getState()){case y.Idle:this.onClickIdle(f,e,o,i);break;case y.Playable:this.onClickPlayable(f,e,o,i);break;case y.Selected:this.onClickSelected(e)}}},t.prototype.onClickIdle=function(t,e,o,l){var u,a,s,h=null===(s=e.getFieldByNotation(t))||void 0===s?void 0:s.getFigure(),f=l.getHistory().getLastMove(),c=f?C.convert(f.color):"White";if(h&&h.getColor()===c){var g=e.getFieldByNotation(t);null==g||g.setState(y.Selected);var d=o.getMovablesForField(t,e,l,o);try{for(var v=i(d),p=v.next();!p.done;p=v.next()){var b=p.value,m=e.getFieldByNotation(b);null==m||m.setState(y.Playable)}}catch(t){u={error:t}}finally{try{p&&!p.done&&(a=v.return)&&a.call(v)}finally{if(u)throw u.error}}this.clear(e,r(r([],n(d)),[t]))}else this.clear(e)},t.prototype.onClickPlayable=function(t,e,o,i){var n,r=e.getFields(),l=null;t:for(var u in r)for(var a in r[u]){var s=null===(n=null==r?void 0:r[Number(u)])||void 0===n?void 0:n[Number(a)];if((null==s?void 0:s.getState())===y.Selected){l=k.toNotation(Number(u),Number(a));break t}}l&&(o.move(l,t,e,i,o),this.clear(e))},t.prototype.onClickSelected=function(t){this.clear(t)},t.prototype.clear=function(t,e){var o;void 0===e&&(e=[]);var i=t.getFields();for(var n in i)for(var r in i[n]){var l=k.toNotation(Number(n),Number(r));if(l&&!e.includes(l)){var u=null===(o=null==i?void 0:i[Number(n)])||void 0===o?void 0:o[Number(r)];null==u||u.setState(y.Idle)}}},t}(),J=function(){function t(t,e){this.context=null,this.sizes=[0,0];var o=e.getContext("2d"),i=new Image;this.sprite=new Promise((function(e,o){i.onload=function(){return e(i)},i.onerror=o,i.src=t.data.figuresSpritePath})),o&&(this.context=o,this.sizes=[e.width,e.height])}return t.prototype.render=function(t){if(this.context){var e=n(this.sizes,2),o=[e[0]/8,e[1]/8],i=t.getFields();for(var l in i){var u=i[l],a=function(t){var e,i=u[Number(t)],a=null==i?void 0:i.getColor(),h=null==i?void 0:i.getFigure();a&&(s.context.fillStyle=a);var f=M.fromIndex.apply(M,r([Number(l),Number(t)],n(o)));if((e=s.context).fillRect.apply(e,r(r([],n(f)),n(o))),h){var c=h.getVisuals().serialize(),g=s.context;s.sprite.then((function(t){return g.drawImage.apply(g,r(r(r([t],n(c)),n(f)),n(o)))})).catch((function(){return console.error("Could not resolve figures path, please check if it is valid.")}))}},s=this;for(var h in u)a(h)}}},t}(),Z=function(){function t(t){this.fields=Array.from({length:t.data.fieldRows}).map((function(e,o){return Array.from({length:t.data.fieldCols}).map((function(t,e){return(o+e)%2==0?new U:new G}))}))}return t.prototype.setFields=function(t){this.fields=t},t.prototype.getFields=function(){return this.fields},t.prototype.getFieldByNotation=function(t){var e=n(k.fromNotation(t),2),o=e[0],i=e[1];return this.getFieldByIndex(o,i)},t.prototype.getFieldByIndex=function(t,e){var o,i,n;return null!==(n=null===(i=null===(o=this.fields)||void 0===o?void 0:o[t])||void 0===i?void 0:i[e])&&void 0!==n?n:null},t.prototype.getSelectedField=function(){return this.fields.flat().find((function(t){return t.getState()===y.Selected}))},t.prototype.findKing=function(t){return tt.findKing(this.fields,t)},t}(),tt=function(){function t(){}return t.findKing=function(t,e){var o,i=null;t:for(var n in t)for(var r in t[n]){var l=null===(o=null==t?void 0:t[Number(n)])||void 0===o?void 0:o[Number(r)];if(l){var u=l.getFigure();if(u&&"King"===u.getName()&&u.getColor()===e){i=k.toNotation(Number(n),Number(r));break t}}}return i},t}(),et=function(){function t(){}return t.clone=function(t){var e=new X,o=new Z(e);return o.setFields(t.getFields()),o},t}(),ot=function(){function t(t){this.listeners=t.listeners,this.switches=t.switches,this.data=t.data}return t.prototype.setup=function(t){var e,o,r;try{for(var l=i(Object.entries(this.data.layout)),u=l.next();!u.done;u=l.next()){var a=n(u.value,2),s=a[0],h=a[1];null===(r=t.getFieldByNotation(s))||void 0===r||r.setFigure(h)}}catch(t){e={error:t}}finally{try{u&&!u.done&&(o=l.return)&&o.call(l)}finally{if(e)throw e.error}}},t.prototype.move=function(t,e,o,n,r){var l,u,a,s,h,f,c,g,d,v,p=o.getFieldByNotation(t),b=null==p?void 0:p.getFigure();if(b){var y=this.data.movements[b.getName()].make(o,t,e),m=n.buildMove(y),N=n.isFollowingPlan(m);if(N||!this.switches.shouldEndOnPlanViolation){if(N||!this.switches.shouldEnforcePlan){try{for(var w=i(y),F=w.next();!F.done;F=w.next()){var k=F.value;!k.from&&k.to&&(null===(a=o.getFieldByNotation(k.to))||void 0===a||a.setFigure(k.figure)),k.from&&!k.to&&(null===(s=o.getFieldByNotation(k.from))||void 0===s||s.setFigure(null)),k.from&&k.to&&(null===(h=o.getFieldByNotation(k.from))||void 0===h||h.setFigure(null),null===(f=o.getFieldByNotation(k.to))||void 0===f||f.setFigure(k.figure))}}catch(t){l={error:t}}finally{try{F&&!F.done&&(u=w.return)&&u.call(w)}finally{if(l)throw l.error}}if(n.move(m),this.listeners.onMove(m,n.getHistory().list()),this.isCheckmate(o,n,r))this.listeners.onEnd(null!==(g=null===(c=n.getHistory().getLastMove())||void 0===c?void 0:c.color)&&void 0!==g?g:"White");else{var B=n.getNextInevitable();B&&this.move(null!==(d=B.fromPosition)&&void 0!==d?d:"",null!==(v=B.toPosition)&&void 0!==v?v:"",o,n,r)}}}else this.listeners.onEnd()}},t.prototype.getAttackablesForField=function(t,e){var o=e.getFieldByNotation(t),i=null==o?void 0:o.getFigure();return i?this.data.movements[i.getName()].canAttackTo(e,t):[]},t.prototype.getMovablesForField=function(t,e,o,n){var r,l,u,a,s,h,f,c,g=e.getFieldByNotation(t),d=null==g?void 0:g.getFigure();if(!d)return[];var v=this.data.movements[d.getName()].canMoveTo(e,t,o.getHistory(),n),p="King"===d.getName(),b=p?t:e.findKing(d.getColor());if(!b)return[];var y=[];try{for(var m=i(v),N=m.next();!N.done;N=m.next()){var w=N.value,F=et.clone(e),k=null!==(a=null===(u=F.getFieldByNotation(w))||void 0===u?void 0:u.getFigure())&&void 0!==a?a:null;null===(s=F.getFieldByNotation(t))||void 0===s||s.setFigure(null),null===(h=F.getFieldByNotation(w))||void 0===h||h.setFigure(d),this.isAttacked(F,p?w:b,C.convert(d.getColor()))||y.push(w),null===(f=F.getFieldByNotation(w))||void 0===f||f.setFigure(k),null===(c=F.getFieldByNotation(t))||void 0===c||c.setFigure(d)}}catch(t){r={error:t}}finally{try{N&&!N.done&&(l=m.return)&&l.call(m)}finally{if(r)throw r.error}}return y},t.prototype.isAttacked=function(t,e,o){var n,r,l,u,a=[],s=t.getFields();for(var h in s)for(var f in s[h]){var c=null===(u=null===(l=s[Number(h)])||void 0===l?void 0:l[Number(f)])||void 0===u?void 0:u.getFigure(),g=k.toNotation(Number(h),Number(f));g&&c&&c.getColor()===o&&a.push(g)}var d=!1;try{for(var v=i(a),p=v.next();!p.done;p=v.next()){var b=p.value;if(this.getAttackablesForField(b,t).includes(e)){d=!0;break}}}catch(t){n={error:t}}finally{try{p&&!p.done&&(r=v.return)&&r.call(v)}finally{if(n)throw n.error}}return d},t.prototype.isCheckmate=function(t,e,o){var i,n,r=e.getHistory().getLastMove();if(!r)return!1;var l=C.convert(r.color),u=t.findKing(l);if(!u)return!1;if(this.isAttacked(t,u,l)&&0===this.getMovablesForField(u,t,e,o).length){var a=t.getFields(),s=0;for(var h in a)for(var f in a[h]){var c=null===(n=null===(i=a[Number(h)])||void 0===i?void 0:i[Number(f)])||void 0===n?void 0:n.getFigure(),g=k.toNotation(Number(h),Number(f));g&&c&&c.getColor()===l&&(s+=this.getMovablesForField(g,t,e,o).length)}if(0===s)return!0}return!1},t}(),it=function(){function t(){this.moves=[]}return t.prototype.pushMove=function(t){this.moves.push(t)},t.prototype.list=function(){return this.moves},t.prototype.filter=function(t){var e=t.color,o=t.name,i=t.id;return this.moves.filter((function(t){var n=!0;return i&&n&&(n=t.id===i),o&&n&&(n=t.name===o),e&&n&&(n=t.color===e),n}))},t.prototype.getLastMove=function(){var t;return null!==(t=this.moves[this.moves.length-1])&&void 0!==t?t:null},t.prototype.getMoveCount=function(){return this.moves.length},t}(),nt=function(){function t(t,e){this.followablePlan=null!=t?t:{White:[],Black:[]},this.inevitablePlan=null!=e?e:{White:[],Black:[]}}return t.prototype.getNextInevitablePlan=function(t,e){var o;return null!==(o=this.inevitablePlan[null!=t?t:"White"][Math.floor(e/2)])&&void 0!==o?o:null},t.prototype.getNextFollowingPlan=function(t,e){var o;return null!==(o=this.followablePlan[null!=t?t:"White"][Math.floor(e/2)])&&void 0!==o?o:null},t.prototype.listFollowablePlan=function(t,e){return this.inevitablePlan[t].slice(Math.floor(e/2))},t.prototype.listInevitablePlan=function(t,e){return this.inevitablePlan[t].slice(Math.floor(e/2))},t}(),rt=function(){function t(){}return t.convertMoveEventsToRecord=function(t){var e,i,n,r,l,u,a,s,h=o({capture:this.isCapture(t),pawnEnPassant:this.isEnPassant(t),pawnLongMove:this.isPawnLongMove(t),promotion:this.getPromotedFigure(t)},this.isCastle(t)),f=this.extractMainMove(t);return new Y([null!==(e=null==f?void 0:f.from)&&void 0!==e?e:null,null!==(i=null==f?void 0:f.to)&&void 0!==i?i:null],{color:null!==(r=null===(n=null==f?void 0:f.figure)||void 0===n?void 0:n.getColor())&&void 0!==r?r:"White",name:null!==(u=null===(l=null==f?void 0:f.figure)||void 0===l?void 0:l.getName())&&void 0!==u?u:"King",id:null!==(s=null===(a=null==f?void 0:f.figure)||void 0===a?void 0:a.getId())&&void 0!==s?s:null},h)},t.isCapture=function(t){return t.filter((function(t){return!t.to})).length>t.filter((function(t){return!t.from})).length},t.getPromotedFigure=function(t){var e,o,i=t.find((function(t){return!t.from}));return null!==(o=null===(e=null==i?void 0:i.figure)||void 0===e?void 0:e.getName())&&void 0!==o?o:null},t.isCastle=function(t){if(2!==t.length)return!1;if(!(1===new Set(t.map((function(t){return t.figure.getColor()}))).size))return!1;var e=t.find((function(t){return"Rook"===t.figure.getName()})),o=t.find((function(t){return"King"===t.figure.getName()}));if(!e||!o)return!1;if(!e.from||!e.to)return!1;var i=n(k.fromNotation(e.from),2)[1],r=n(k.fromNotation(e.to),2)[1];return 2===Math.abs(i-r)?{castleLong:!1,castleShort:!0}:{castleShort:!1,castleLong:!0}},t.isPawnLongMove=function(t){if(1!==t.length)return!1;var e=n(t,1)[0];if(!(null==e?void 0:e.from)||!(null==e?void 0:e.to))return!1;var o=n(k.fromNotation(e.from),1)[0],i=n(k.fromNotation(e.to),1)[0];return 2===Math.abs(o-i)},t.isEnPassant=function(t){if(!t.every((function(t){return"Pawn"===t.figure.getName()}))||2!==t.length)return!1;if(!this.isCapture(t))return!1;var e=t.find((function(t){return!t.to})),o=t.find((function(t){return t.to}));return!(!e||!o)&&e.from!==o.to},t.extractMainMove=function(t){return t.find((function(t){return t.from&&t.to}))},t}(),lt=function(){function t(t){this.history=new it,this.plan=new nt(t.data.followablePlan,t.data.inevitablePlan),this.listeners=t.listeners}return t.prototype.getHistory=function(){return this.history},t.prototype.buildMove=function(t){return rt.convertMoveEventsToRecord(t)},t.prototype.move=function(t){this.history.pushMove(t)},t.prototype.getNextInevitable=function(){var t=this.history.getLastMove(),e=t?C.convert(t.color):"White";return this.plan.getNextInevitablePlan(e,this.history.getMoveCount())},t.prototype.isFollowingPlan=function(t){var e=this.plan.getNextFollowingPlan(t.color,this.history.getMoveCount());if(!e)return!0;var o=e.equals(t);return o?this.listeners.onPlanContinuance(t,this.plan.listFollowablePlan(t.color,this.history.getMoveCount()),this.history.filter({color:t.color})):this.listeners.onPlanViolation(t,this.plan.listFollowablePlan(t.color,this.history.getMoveCount()),this.history.filter({color:t.color})),o},t}(),ut=function(){function t(t){this.state=null,this.rules=null,this.time=null,this.renderer=null,this.gui=null,this.config=t}return t.prototype.makeState=function(){return this.state?this.state:new Z(this.config.state)},t.prototype.makeRules=function(){return this.rules?this.rules:new ot(this.config.rules)},t.prototype.makeTime=function(){return this.time?this.time:new lt(this.config.time)},t.prototype.makeGui=function(t){return this.gui?this.gui:new $(t)},t.prototype.makeRenderer=function(t){return this.renderer?this.renderer:new J(this.config.renderer,t)},t}(),at=function(t,e){var o=this,i=new ut(new D(null!=e?e:{}));this.state=i.makeState(),this.rules=i.makeRules(),this.gui=i.makeGui(t),this.renderer=i.makeRenderer(t),this.time=i.makeTime(),t.onclick=function(e){var i=t.getBoundingClientRect(),n=Math.max(e.clientX-i.left,0),r=Math.max(e.clientY-i.top);o.gui.onClick([n,r],o.state,o.rules,o.time),o.renderer.render(o.state)},this.rules.setup(this.state),this.renderer.render(this.state)},st=function(t){return new(at.bind.apply(at,r([void 0],n(t))))};export{st as createBoard};
