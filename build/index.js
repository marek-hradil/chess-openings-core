/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var t=function(e,o){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])})(e,o)};function e(e,o){if("function"!=typeof o&&null!==o)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}var o=function(){return(o=Object.assign||function(t){for(var e,o=1,i=arguments.length;o<i;o++)for(var n in e=arguments[o])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function i(t){var e="function"==typeof Symbol&&Symbol.iterator,o=e&&t[e],i=0;if(o)return o.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function n(t,e){var o="function"==typeof Symbol&&t[Symbol.iterator];if(!o)return t;var i,n,r=o.call(t),l=[];try{for(;(void 0===e||e-- >0)&&!(i=r.next()).done;)l.push(i.value)}catch(t){n={error:t}}finally{try{i&&!i.done&&(o=r.return)&&o.call(r)}finally{if(n)throw n.error}}return l}function r(t,e){for(var o=0,i=e.length,n=t.length;o<i;o++,n++)t[n]=e[o];return t}var l,u=function(){function t(t,e){this.spriteX=0,this.spriteY=0,this.spriteHeight=45,this.spriteWidth=45;var o=n(this.setSpriteCoordinates(t,e),2),i=o[0],r=o[1];this.spriteX=null!=i?i:0,this.spriteY=null!=r?r:0}return t.prototype.serialize=function(){return[this.spriteX,this.spriteY,this.spriteWidth,this.spriteHeight]},t.prototype.setSpriteCoordinates=function(t,e){var o="White"===e?0:45;switch(t){case"King":return[0,o];case"Queen":return[45,o];case"Bishop":return[90,o];case"Knight":return[135,o];case"Rook":return[180,o];case"Pawn":return[225,o]}},t}(),a=function(){function t(t,e,o){this.startingPosition=o,this.name=t,this.color=e,this.visuals=new u(t,e)}return t.prototype.getColor=function(){return this.color},t.prototype.getName=function(){return this.name},t.prototype.getVisuals=function(){return this.visuals},t.prototype.getStartingPosition=function(){return this.startingPosition},t}(),s=function(t){function o(e,o){return t.call(this,"Bishop",e,o)||this}return e(o,t),o}(a);!function(t){t.Linear="Linear",t.Simple="Simple"}(l||(l={}));var h,f,c=function(){function t(){}return t.prototype.make=function(t,e,o){var i,l,u=null===(i=t.getFieldByNotation(e))||void 0===i?void 0:i.getFigure(),a=null===(l=t.getFieldByNotation(o))||void 0===l?void 0:l.getFigure();return u?r(r([],n(a?[{from:o,to:null,figure:a}]:[])),[{from:e,to:o,figure:u}]):[]},t}(),g=function(t){function o(){var e=null!==t&&t.apply(this,arguments)||this;return e.type=l.Simple,e}return e(o,t),o.prototype.checkAttackable=function(t){var e,o,n=[];try{for(var r=i(t),l=r.next();!l.done;l=r.next()){var u=l.value;u&&n.push(u)}}catch(t){e={error:t}}finally{try{l&&!l.done&&(o=r.return)&&o.call(r)}finally{if(e)throw e.error}}return n},o.prototype.checkMovable=function(t,e,o){var n,r,l,u,a=[],s=e.getFieldByNotation(t);try{for(var h=i(o),f=h.next();!f.done;f=h.next()){var c=f.value;if(c){var g=e.getFieldByNotation(c);(null==g?void 0:g.getFigure())&&(null===(l=null==g?void 0:g.getFigure())||void 0===l?void 0:l.getColor())===(null===(u=null==s?void 0:s.getFigure())||void 0===u?void 0:u.getColor())||a.push(c)}}}catch(t){n={error:t}}finally{try{f&&!f.done&&(r=h.return)&&r.call(h)}finally{if(n)throw n.error}}return a},o}(c),d=function(t){function o(){var e=null!==t&&t.apply(this,arguments)||this;return e.type=l.Linear,e}return e(o,t),o.prototype.iterateMovable=function(t,e,o){for(var i,n,r=t.getFieldByNotation(e),l=[],u=o(e),a=u&&t.getFieldByNotation(u);u&&a&&!a.getFigure();)l.push(u),a=(u=o(u))&&t.getFieldByNotation(u);return u&&a&&(null===(i=a.getFigure())||void 0===i?void 0:i.getColor())!==(null===(n=null==r?void 0:r.getFigure())||void 0===n?void 0:n.getColor())&&l.push(u),l},o.prototype.iterateAttackable=function(t,e,o){for(var i=[],n=o(e),r=n&&t.getFieldByNotation(n);n&&r&&!r.getFigure();)i.push(n),r=(n=o(n))&&t.getFieldByNotation(n);return n&&r&&i.push(n),i},o}(c),v=function(){function t(){}return t.toNotation=function(t,e){var o,i,n=null===(o=this.colNotation)||void 0===o?void 0:o[e],r=null===(i=this.rowNotation)||void 0===i?void 0:i[t];return n&&r?n+r:null},t.fromNotation=function(t){var e=n(t.split(""),2),o=e[0],i=e[1];return i&&o?[this.rowNotation.indexOf(i),this.colNotation.indexOf(o)]:[0,0]},t.rowNotation=["8","7","6","5","4","3","2","1"],t.colNotation=["a","b","c","d","e","f","g","h"],t}(),p=function(){function t(){}return t.measureLengthOfMove=function(t,e){var o=n(v.fromNotation(t),2),i=o[0],r=o[1],l=n(v.fromNotation(e),2),u=n([i-l[0],r-l[1]],2),a=u[0],s=u[1];return Math.sqrt(Math.pow(a,2)+Math.pow(s,2))},t}(),b=function(){function t(){}return t.topNeighbour=function(e){return t.useNotation(e,[-1,0])},t.bottomNeighbour=function(e){return t.useNotation(e,[1,0])},t.leftNeighbour=function(e){return t.useNotation(e,[0,-1])},t.rightNeighbour=function(e){return t.useNotation(e,[0,1])},t.topLeftNeighbour=function(e){return t.useNotation(e,[-1,-1])},t.topRightNeighbour=function(e){return t.useNotation(e,[-1,1])},t.bottomLeftNeighbour=function(e){return t.useNotation(e,[1,-1])},t.bottomRightNeighbour=function(e){return t.useNotation(e,[1,1])},t.topLeftKnightNeighbour=function(e){return t.useNotation(e,[-2,-1])},t.topRightKnightNeighbour=function(e){return t.useNotation(e,[-2,1])},t.leftTopKnightNeighbour=function(e){return t.useNotation(e,[-1,-2])},t.leftBottomKnightNeighbour=function(e){return t.useNotation(e,[1,-2])},t.bottomLeftKnightNeighbour=function(e){return t.useNotation(e,[2,-1])},t.bottomRightKnightNeighbour=function(e){return t.useNotation(e,[2,1])},t.rightBottomKnightNeighbour=function(e){return t.useNotation(e,[1,2])},t.rightTopKnightNeighbour=function(e){return t.useNotation(e,[-1,2])},t.useNotation=function(t,e){var o=n(v.fromNotation(t),2),i=o[0],r=o[1];return v.toNotation(i+e[0],r+e[1])},t}(),y=function(){function t(){}return t.toIndex=function(t,e,o,i){return[Math.floor(e/i),Math.floor(t/o)]},t.fromIndex=function(t,e,o,i){return[e*o,t*i]},t}(),m=function(){function t(){}return t.convert=function(t){return"White"===t?"Black":"White"},t}(),N=function(t){function o(){return null!==t&&t.apply(this,arguments)||this}return e(o,t),o.prototype.canAttackTo=function(t,e){return r(r(r(r([],n(this.iterateAttackable(t,e,b.topLeftNeighbour))),n(this.iterateAttackable(t,e,b.topRightNeighbour))),n(this.iterateAttackable(t,e,b.bottomLeftNeighbour))),n(this.iterateAttackable(t,e,b.bottomRightNeighbour)))},o.prototype.canMoveTo=function(t,e){return r(r(r(r([],n(this.iterateMovable(t,e,b.topLeftNeighbour))),n(this.iterateMovable(t,e,b.topRightNeighbour))),n(this.iterateMovable(t,e,b.bottomLeftNeighbour))),n(this.iterateMovable(t,e,b.bottomRightNeighbour)))},o}(d),w=function(t){function o(e,o){return t.call(this,"King",e,o)||this}return e(o,t),o}(a),F=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i.prototype.make=function(t,e,o){var i,r,l,u=p.measureLengthOfMove(e,o),a=null===(i=t.getFieldByNotation(e))||void 0===i?void 0:i.getFigure();if(!a)return[];if(2!==u){var s=null===(r=t.getFieldByNotation(o))||void 0===r?void 0:r.getFigure();return s?[{from:o,to:null,figure:s},{from:e,to:o,figure:a}]:[{from:e,to:o,figure:a}]}var h=n(v.fromNotation(e),2)[1]-n(v.fromNotation(o),2)[1],f=a.getColor(),c=h<0,g=c?"White"===f?"h1":"h8":"White"===f?"a1":"a8",d=c?"White"===f?"f1":"f8":"White"===f?"d1":"d8",b=null===(l=t.getFieldByNotation(g))||void 0===l?void 0:l.getFigure();return b?[{from:e,to:o,figure:a},{from:g,to:d,figure:b}]:[]},i.prototype.canAttackTo=function(t,e){return this.checkAttackable([b.topLeftNeighbour(e),b.topNeighbour(e),b.topRightNeighbour(e),b.leftNeighbour(e),b.bottomLeftNeighbour(e),b.bottomNeighbour(e),b.bottomRightNeighbour(e),b.rightNeighbour(e)])},i.prototype.canMoveTo=function(t,e,i,l){var u,a=null===(u=t.getFieldByNotation(e))||void 0===u?void 0:u.getFigure();if(!a)return[];var s=this.checkMovable(e,t,[b.topLeftNeighbour(e),b.topNeighbour(e),b.topRightNeighbour(e),b.leftNeighbour(e),b.bottomLeftNeighbour(e),b.bottomNeighbour(e),b.bottomRightNeighbour(e),b.rightNeighbour(e)]),h=Boolean(i.filter({startingPosition:a.getStartingPosition()}).length),f=l.isAttacked(t,e,m.convert(a.getColor()));if(h||f)return s;var c=i.filter({name:"Rook",color:a.getColor()}).reduce((function(t,e){var i,l,u;return t[e.startingPosition]?o(o({},t),((i={})[e.startingPosition]=r(r([],n(null!==(u=t[e.startingPosition])&&void 0!==u?u:[])),[e]),i)):o(o({},t),((l={})[e.startingPosition]=[e],l))}),{});if(2===Object.keys(c).length)return s;var g=Array.from({length:3}).reduce((function(t,o,i){var l;return r(r([],n(t)),[b.rightNeighbour(null!==(l=null==t?void 0:t[i-1])&&void 0!==l?l:e)])}),[]),d=Array.from({length:4}).reduce((function(t,o,i){var l;return r(r([],n(t)),[b.leftNeighbour(null!==(l=null==t?void 0:t[i-1])&&void 0!==l?l:e)])}),[]),v=function(e,o,i,n){var r,u,s,h=i===n.length-1,f=4===n.length&&2===i,g=!(null===(r=t.getFieldByNotation(o))||void 0===r?void 0:r.getFigure()),d=l.isAttacked(t,o,m.convert(a.getColor()));if(!h)return f?e&&g:e&&g&&!d;var v=null===(s=null===(u=t.getFieldByNotation(o))||void 0===u?void 0:u.getFigure())||void 0===s?void 0:s.getStartingPosition();if(!v)return!1;var p=Boolean(c[v]);return e&&!p},p=g.reduce(v,!0),y=d.reduce(v,!0),N=[];return p&&g[1]&&N.push(g[1]),y&&d[1]&&N.push(d[1]),r(r([],n(s)),n(N))},i}(g),P=function(t){function o(e,o){return t.call(this,"Knight",e,o)||this}return e(o,t),o}(a),k=function(t){function o(){return null!==t&&t.apply(this,arguments)||this}return e(o,t),o.prototype.canAttackTo=function(t,e){return this.checkAttackable([b.topLeftKnightNeighbour(e),b.topRightKnightNeighbour(e),b.leftTopKnightNeighbour(e),b.leftBottomKnightNeighbour(e),b.bottomLeftKnightNeighbour(e),b.bottomRightKnightNeighbour(e),b.rightBottomKnightNeighbour(e),b.rightTopKnightNeighbour(e)])},o.prototype.canMoveTo=function(t,e){return this.checkMovable(e,t,[b.topLeftKnightNeighbour(e),b.topRightKnightNeighbour(e),b.leftTopKnightNeighbour(e),b.leftBottomKnightNeighbour(e),b.bottomLeftKnightNeighbour(e),b.bottomRightKnightNeighbour(e),b.rightBottomKnightNeighbour(e),b.rightTopKnightNeighbour(e)])},o}(g),B=function(t){function o(e,o){return t.call(this,"Pawn",e,o)||this}return e(o,t),o}(a),M=function(t){function o(e,o){return t.call(this,"Queen",e,o)||this}return e(o,t),o}(a),C=function(t){function o(){return null!==t&&t.apply(this,arguments)||this}return e(o,t),o.prototype.make=function(t,e,o){var i,r,l,u,a=null===(i=t.getFieldByNotation(e))||void 0===i?void 0:i.getFigure(),s=null===(r=t.getFieldByNotation(o))||void 0===r?void 0:r.getFigure();if(!a)return[];var h=n(v.fromNotation(e),2)[1],f=n(v.fromNotation(o),2),c=f[0],g=f[1];if(0===c||7===c)return s?[{from:o,to:null,figure:s},{from:e,to:null,figure:a},{from:null,to:o,figure:new M(a.getColor(),o)}]:[{from:e,to:null,figure:a},{from:null,to:o,figure:new M(a.getColor(),o)}];if(s)return[{from:o,to:null,figure:s},{from:e,to:o,figure:a}];if(h===g)return[{from:e,to:o,figure:a}];var d=b.bottomNeighbour(o);if("White"===a.getColor()&&d)return(p=null===(l=t.getFieldByNotation(d))||void 0===l?void 0:l.getFigure())?[{from:e,to:o,figure:a},{from:d,to:null,figure:p}]:[];var p,y=b.topNeighbour(o);return"Black"===a.getColor()&&y&&(p=null===(u=t.getFieldByNotation(y))||void 0===u?void 0:u.getFigure())?[{from:e,to:o,figure:a},{from:y,to:null,figure:p}]:[]},o.prototype.canAttackTo=function(t,e){var o,i=null===(o=t.getFieldByNotation(e))||void 0===o?void 0:o.getFigure();if(!i)return[];var r=n("White"===i.getColor()?[b.topLeftNeighbour,b.topRightNeighbour]:[b.bottomLeftNeighbour,b.bottomRightNeighbour],2),l=r[0],u=r[1],a=[],s=l(e);s&&a.push(s);var h=u(e);return h&&a.push(h),a},o.prototype.canMoveTo=function(t,e,o){var i,l,u,a=null===(i=t.getFieldByNotation(e))||void 0===i?void 0:i.getFigure();if(!a)return[];var s="White"===a.getColor()?b.topNeighbour:b.bottomNeighbour,h=n("White"===a.getColor()?[b.topLeftNeighbour,b.topRightNeighbour]:[b.bottomLeftNeighbour,b.bottomRightNeighbour],2),f=h[0],c=h[1],g=[],d=s(e);d&&!(null===(l=t.getFieldByNotation(d))||void 0===l?void 0:l.getFigure())&&g.push(d);var p=Boolean(o.filter({startingPosition:a.getStartingPosition()}).length),y=d&&g.includes(d)&&s(d);p||!y||(null===(u=t.getFieldByNotation(y))||void 0===u?void 0:u.getFigure())||g.push(y);var N=function(e){var o,i;return(null===(i=null===(o=t.getFieldByNotation(e))||void 0===o?void 0:o.getFigure())||void 0===i?void 0:i.getColor())===m.convert(a.getColor())},w=f(e);w&&N(w)&&g.push(w);var F=c(e);F&&N(F)&&g.push(F);var P=o.getLastMove();if(!P)return g;if(!(P.specials.pawnLongMove&&P.color===m.convert(a.getColor()))||!P.toPosition)return g;var k=n(v.fromNotation(e),2),B=k[0],M=k[1],C=n(v.fromNotation(P.toPosition),2),R=C[0],A=C[1];if(B!==R||1!==Math.abs(M-A))return g;var W=b.topNeighbour(P.toPosition),S=b.bottomNeighbour(P.toPosition);return"White"===a.getColor()&&W?r(r([],n(g)),[W]):"Black"===a.getColor()&&S?r(r([],n(g)),[S]):g},o}(g),R=function(t){function o(){return null!==t&&t.apply(this,arguments)||this}return e(o,t),o.prototype.canAttackTo=function(t,e){return r(r(r(r(r(r(r(r([],n(this.iterateAttackable(t,e,b.topNeighbour))),n(this.iterateAttackable(t,e,b.topLeftNeighbour))),n(this.iterateAttackable(t,e,b.leftNeighbour))),n(this.iterateAttackable(t,e,b.bottomLeftNeighbour))),n(this.iterateAttackable(t,e,b.bottomNeighbour))),n(this.iterateAttackable(t,e,b.bottomRightNeighbour))),n(this.iterateAttackable(t,e,b.rightNeighbour))),n(this.iterateAttackable(t,e,b.topRightNeighbour)))},o.prototype.canMoveTo=function(t,e){return r(r(r(r(r(r(r(r([],n(this.iterateMovable(t,e,b.topNeighbour))),n(this.iterateMovable(t,e,b.topLeftNeighbour))),n(this.iterateMovable(t,e,b.leftNeighbour))),n(this.iterateMovable(t,e,b.bottomLeftNeighbour))),n(this.iterateMovable(t,e,b.bottomNeighbour))),n(this.iterateMovable(t,e,b.bottomRightNeighbour))),n(this.iterateMovable(t,e,b.rightNeighbour))),n(this.iterateMovable(t,e,b.topRightNeighbour)))},o}(d),A=function(t){function o(e,o){return t.call(this,"Rook",e,o)||this}return e(o,t),o}(a),W=function(t){function o(){return null!==t&&t.apply(this,arguments)||this}return e(o,t),o.prototype.canAttackTo=function(t,e){return r(r(r(r([],n(this.iterateAttackable(t,e,b.topNeighbour))),n(this.iterateAttackable(t,e,b.leftNeighbour))),n(this.iterateAttackable(t,e,b.bottomNeighbour))),n(this.iterateAttackable(t,e,b.rightNeighbour)))},o.prototype.canMoveTo=function(t,e){return r(r(r(r([],n(this.iterateMovable(t,e,b.topNeighbour))),n(this.iterateMovable(t,e,b.leftNeighbour))),n(this.iterateMovable(t,e,b.rightNeighbour))),n(this.iterateMovable(t,e,b.bottomNeighbour)))},o}(d),S=function(t){var e,o,i,n,r,l,u,a;this.defaultLayout={a1:new A("White","a1"),b1:new P("White","b1"),c1:new s("White","c1"),e1:new w("White","e1"),d1:new M("White","d1"),f1:new s("White","f1"),g1:new P("White","g1"),h1:new A("White","h1"),a2:new B("White","a2"),b2:new B("White","b2"),c2:new B("White","c2"),d2:new B("White","d2"),e2:new B("White","e2"),f2:new B("White","f2"),g2:new B("White","g2"),h2:new B("White","h2"),a8:new A("Black","a8"),b8:new P("Black","b8"),c8:new s("Black","c8"),d8:new M("Black","d8"),e8:new w("Black","e2"),f8:new s("Black","f8"),g8:new P("Black","g8"),h8:new A("Black","h8"),a7:new B("Black","a7"),b7:new B("Black","b7"),c7:new B("Black","c7"),d7:new B("Black","d7"),e7:new B("Black","e7"),f7:new B("Black","f7"),g7:new B("Black","g7"),h7:new B("Black","h7")},this.layout=this.defaultLayout,this.defaultMovements={Bishop:new N,King:new F,Queen:new R,Pawn:new C,Rook:new W,Knight:new k},this.movements=this.defaultMovements,this.fieldRows=8,this.fieldCols=8,this.figuresSpritePath="/figures/sprite.svg",this.shouldRenderAsBlack=!1,this.inevitablePlan={White:new Array,Black:new Array},this.followablePlan={White:new Array,Black:new Array},"BoardRules"===t.type&&(this.layout=null!==(e=t.layout)&&void 0!==e?e:this.defaultLayout,this.movements=null!==(o=t.movements)&&void 0!==o?o:this.defaultMovements),"BoardState"===t.type&&(this.fieldRows=null!==(i=t.fieldRows)&&void 0!==i?i:8,this.fieldCols=null!==(n=t.fieldCols)&&void 0!==n?n:8),"BoardRenderer"===t.type&&(this.figuresSpritePath=null!==(r=t.figuresSpritePath)&&void 0!==r?r:"/figures/sprite.svg",this.shouldRenderAsBlack=null!==(l=t.shouldRenderAsBlack)&&void 0!==l&&l),"BoardTime"===t.type&&(this.inevitablePlan=null!==(u=t.inevitablePlan)&&void 0!==u?u:{White:[],Black:[]},this.followablePlan=null!==(a=t.followablePlan)&&void 0!==a?a:{White:[],Black:[]})},L=function(t){var e,o,i;this.shouldEndOnPlanViolation=!0,this.shouldEnforcePlan=!0,this.shouldRenderAsBlack=!1,"BoardRules"===t.type&&(this.shouldEndOnPlanViolation=null===(e=null==t?void 0:t.shouldEndOnPlanViolation)||void 0===e||e,this.shouldEnforcePlan=null===(o=null==t?void 0:t.shouldEnforcePlan)||void 0===o||o),"BoardRenderer"===t.type&&(this.shouldRenderAsBlack=null!==(i=null==t?void 0:t.shouldRenderAsBlack)&&void 0!==i&&i)},x=function(t){this.data=new S({type:"BoardRenderer",figuresSpritePath:null==t?void 0:t.figuresSpritePath}),this.switches=new L({type:"BoardRenderer",shouldRenderAsBlack:!1})},K=function(t){var e,o,i,n;this.onPlanContinuance=function(){return null},this.onPlanViolation=function(){return null},this.onEnd=function(){return null},this.onMove=function(){return null},"BoardTime"===t.type&&(this.onPlanContinuance=null!==(e=t.onPlanContinuance)&&void 0!==e?e:function(){return null},this.onPlanViolation=null!==(o=t.onPlanViolation)&&void 0!==o?o:function(){return null}),"BoardRules"===t.type&&(this.onEnd=null!==(i=t.onEnd)&&void 0!==i?i:function(){return null},this.onMove=null!==(n=t.onMove)&&void 0!==n?n:function(){return null})},T=function(t){this.listeners=new K({type:"BoardRules",onEnd:null==t?void 0:t.onEnd}),this.switches=new L({type:"BoardRules",shouldEndOnPlanViolation:null==t?void 0:t.shouldEndOnPlanViolation,shouldEnforcePlan:null==t?void 0:t.shouldEnforcePlan}),this.data=new S({type:"BoardRules",layout:null==t?void 0:t.layout,movements:null==t?void 0:t.movements})},E=function(t){this.data=new S({type:"BoardState",fieldRows:null==t?void 0:t.fieldRows,fieldCols:null==t?void 0:t.fieldCols})},I=function(){function t(t,e,i){this.specials={capture:!1,pawnLongMove:!1,pawnEnPassant:!1,castleLong:!1,castleShort:!1,promotion:null},this.fromPosition=t[0],this.toPosition=t[1],this.color=e.color,this.name=e.name,this.startingPosition=e.startingPosition,this.specials=o(o({},this.specials),i)}return t.prototype.equals=function(t){return t.fromPosition===this.fromPosition&&t.toPosition===this.toPosition&&t.color===this.color&&t.name===this.name&&t.specials.promotion===this.specials.promotion},t}(),O=function(){function t(t){this.data=new S({type:"BoardTime",inevitablePlan:this.deserializePlan(null==t?void 0:t.inevitablePlan),followablePlan:this.deserializePlan(null==t?void 0:t.followablePlan)}),this.listeners=new K({type:"BoardTime",onPlanContinuance:null==t?void 0:t.onPlanContinuance,onPlanViolation:null==t?void 0:t.onPlanViolation})}return t.prototype.deserializePlan=function(t){if(!t)return{White:[],Black:[]};var e=function(t){return t.map((function(t){return new I([t.from,t.to],{color:t.color,name:t.name,startingPosition:t.startingPosition},t)}))};return{White:e(t.White),Black:e(t.Black)}},t}(),V=function(t){this.rules=new T(null==t?void 0:t.rules),this.time=new O(null==t?void 0:t.time),this.state=new E(null==t?void 0:t.state),this.renderer=new x(null==t?void 0:t.renderer)};!function(t){t.Idle="Idle",t.Selected="Selected",t.Playable="Playable"}(h||(h={})),function(t){t.White="White",t.Black="Black"}(f||(f={}));var H=function(){function t(t){this.figure=null,this.state=h.Idle,this.color=t}return t.prototype.getFigure=function(){return this.figure},t.prototype.setFigure=function(t){this.figure=t},t.prototype.getColor=function(){switch(this.state){case h.Idle:return this.color===f.White?"#FBFAF8":"#804E49";case h.Selected:return"#5A914D";case h.Playable:return"#8FAD88"}},t.prototype.getState=function(){return this.state},t.prototype.setState=function(t){this.state=t},t}(),z=function(t){function o(){return t.call(this,f.White)||this}return e(o,t),o}(H),j=function(t){function o(){return t.call(this,f.Black)||this}return e(o,t),o}(H),_=function(){function t(t){this.canvasHeight=t.height,this.canvasWidth=t.width}return t.prototype.onClick=function(t,e,o,i){var r=n(t,2),l=r[0],u=r[1],a=n(y.toIndex(l,u,this.canvasWidth/8,this.canvasHeight/8),2),s=a[0],f=a[1],c=v.toNotation(s,f);if(c){var g=e.getFieldByNotation(c);switch(null==g?void 0:g.getState()){case h.Idle:this.onClickIdle(c,e,o,i);break;case h.Playable:this.onClickPlayable(c,e,o,i);break;case h.Selected:this.onClickSelected(e)}}},t.prototype.onClickIdle=function(t,e,o,l){var u,a,s,f=null===(s=e.getFieldByNotation(t))||void 0===s?void 0:s.getFigure(),c=l.getHistory().getLastMove(),g=c?m.convert(c.color):"White";if(f&&f.getColor()===g){var d=e.getFieldByNotation(t);null==d||d.setState(h.Selected);var v=o.getMovablesForField(t,e,l,o);try{for(var p=i(v),b=p.next();!b.done;b=p.next()){var y=b.value,N=e.getFieldByNotation(y);null==N||N.setState(h.Playable)}}catch(t){u={error:t}}finally{try{b&&!b.done&&(a=p.return)&&a.call(p)}finally{if(u)throw u.error}}this.clear(e,r(r([],n(v)),[t]))}else this.clear(e)},t.prototype.onClickPlayable=function(t,e,o,i){var n,r=e.getFields(),l=null;t:for(var u in r)for(var a in r[u]){var s=null===(n=null==r?void 0:r[Number(u)])||void 0===n?void 0:n[Number(a)];if((null==s?void 0:s.getState())===h.Selected){l=v.toNotation(Number(u),Number(a));break t}}l&&(o.move(l,t,e,i,o),this.clear(e))},t.prototype.onClickSelected=function(t){this.clear(t)},t.prototype.clear=function(t,e){var o;void 0===e&&(e=[]);var i=t.getFields();for(var n in i)for(var r in i[n]){var l=v.toNotation(Number(n),Number(r));if(l&&!e.includes(l)){var u=null===(o=null==i?void 0:i[Number(n)])||void 0===o?void 0:o[Number(r)];null==u||u.setState(h.Idle)}}},t}(),X=function(){function t(t,e){this.context=null,this.sizes=[0,0];var o=e.getContext("2d"),i=new Image;this.sprite=new Promise((function(e,o){i.onload=function(){return e(i)},i.onerror=o,i.src=t.data.figuresSpritePath})),o&&(this.context=o,this.sizes=[e.width,e.height]),this.switches=t.switches}return t.prototype.render=function(t){if(this.context){var e=n(this.sizes,2),o=[e[0]/8,e[1]/8],i=t.getFields();for(var l in i){var u=i[l],a=function(t){var e,i=u[Number(t)],a=null==i?void 0:i.getColor(),h=null==i?void 0:i.getFigure();a&&(s.context.fillStyle=a);var f=y.fromIndex.apply(y,r([s.switches.shouldRenderAsBlack?Math.abs(Number(l)-7):Number(l),s.switches.shouldRenderAsBlack?Math.abs(Number(t)-7):Number(t)],n(o)));if((e=s.context).fillRect.apply(e,r(r([],n(f)),n(o))),h){var c=h.getVisuals().serialize(),g=s.context;s.sprite.then((function(t){return g.drawImage.apply(g,r(r(r([t],n(c)),n(f)),n(o)))})).catch((function(){return console.error("Could not resolve figures path, please check if it is valid.")}))}},s=this;for(var h in u)a(h)}}},t}(),Y=function(){function t(t){this.fields=Array.from({length:t.data.fieldRows}).map((function(e,o){return Array.from({length:t.data.fieldCols}).map((function(t,e){return(o+e)%2==0?new z:new j}))}))}return t.prototype.setFields=function(t){this.fields=t},t.prototype.getFields=function(){return this.fields},t.prototype.getFieldByNotation=function(t){var e=n(v.fromNotation(t),2),o=e[0],i=e[1];return this.getFieldByIndex(o,i)},t.prototype.getFieldByIndex=function(t,e){var o,i,n;return null!==(n=null===(i=null===(o=this.fields)||void 0===o?void 0:o[t])||void 0===i?void 0:i[e])&&void 0!==n?n:null},t.prototype.getSelectedField=function(){return this.fields.flat().find((function(t){return t.getState()===h.Selected}))},t.prototype.findKing=function(t){return q.findKing(this.fields,t)},t}(),q=function(){function t(){}return t.findKing=function(t,e){var o,i=null;t:for(var n in t)for(var r in t[n]){var l=null===(o=null==t?void 0:t[Number(n)])||void 0===o?void 0:o[Number(r)];if(l){var u=l.getFigure();if(u&&"King"===u.getName()&&u.getColor()===e){i=v.toNotation(Number(n),Number(r));break t}}}return i},t}(),Q=function(){function t(){}return t.clone=function(t){var e=new E,o=new Y(e);return o.setFields(t.getFields()),o},t}(),D=function(){function t(t){this.listeners=t.listeners,this.switches=t.switches,this.data=t.data}return t.prototype.setup=function(t){var e,o,r;try{for(var l=i(Object.entries(this.data.layout)),u=l.next();!u.done;u=l.next()){var a=n(u.value,2),s=a[0],h=a[1];null===(r=t.getFieldByNotation(s))||void 0===r||r.setFigure(h)}}catch(t){e={error:t}}finally{try{u&&!u.done&&(o=l.return)&&o.call(l)}finally{if(e)throw e.error}}},t.prototype.move=function(t,e,o,n,r){var l,u,a,s,h,f,c,g,d,v,p=o.getFieldByNotation(t),b=null==p?void 0:p.getFigure();if(b){var y=this.data.movements[b.getName()].make(o,t,e),m=n.buildMove(y),N=n.isFollowingPlan(m);if(N||!this.switches.shouldEndOnPlanViolation){if(N||!this.switches.shouldEnforcePlan){try{for(var w=i(y),F=w.next();!F.done;F=w.next()){var P=F.value;!P.from&&P.to&&(null===(a=o.getFieldByNotation(P.to))||void 0===a||a.setFigure(P.figure)),P.from&&!P.to&&(null===(s=o.getFieldByNotation(P.from))||void 0===s||s.setFigure(null)),P.from&&P.to&&(null===(h=o.getFieldByNotation(P.from))||void 0===h||h.setFigure(null),null===(f=o.getFieldByNotation(P.to))||void 0===f||f.setFigure(P.figure))}}catch(t){l={error:t}}finally{try{F&&!F.done&&(u=w.return)&&u.call(w)}finally{if(l)throw l.error}}if(n.move(m),this.listeners.onMove(m,n.getHistory().list()),this.isCheckmate(o,n,r))this.listeners.onEnd(null!==(g=null===(c=n.getHistory().getLastMove())||void 0===c?void 0:c.color)&&void 0!==g?g:"White");else{var k=n.getNextInevitable();k&&this.move(null!==(d=k.fromPosition)&&void 0!==d?d:"",null!==(v=k.toPosition)&&void 0!==v?v:"",o,n,r)}}}else this.listeners.onEnd()}},t.prototype.getAttackablesForField=function(t,e){var o=e.getFieldByNotation(t),i=null==o?void 0:o.getFigure();return i?this.data.movements[i.getName()].canAttackTo(e,t):[]},t.prototype.getMovablesForField=function(t,e,o,n){var r,l,u,a,s,h,f,c,g=e.getFieldByNotation(t),d=null==g?void 0:g.getFigure();if(!d)return[];var v=this.data.movements[d.getName()].canMoveTo(e,t,o.getHistory(),n),p="King"===d.getName(),b=p?t:e.findKing(d.getColor());if(!b)return[];var y=[];try{for(var N=i(v),w=N.next();!w.done;w=N.next()){var F=w.value,P=Q.clone(e),k=null!==(a=null===(u=P.getFieldByNotation(F))||void 0===u?void 0:u.getFigure())&&void 0!==a?a:null;null===(s=P.getFieldByNotation(t))||void 0===s||s.setFigure(null),null===(h=P.getFieldByNotation(F))||void 0===h||h.setFigure(d),this.isAttacked(P,p?F:b,m.convert(d.getColor()))||y.push(F),null===(f=P.getFieldByNotation(F))||void 0===f||f.setFigure(k),null===(c=P.getFieldByNotation(t))||void 0===c||c.setFigure(d)}}catch(t){r={error:t}}finally{try{w&&!w.done&&(l=N.return)&&l.call(N)}finally{if(r)throw r.error}}return y},t.prototype.isAttacked=function(t,e,o){var n,r,l,u,a=[],s=t.getFields();for(var h in s)for(var f in s[h]){var c=null===(u=null===(l=s[Number(h)])||void 0===l?void 0:l[Number(f)])||void 0===u?void 0:u.getFigure(),g=v.toNotation(Number(h),Number(f));g&&c&&c.getColor()===o&&a.push(g)}var d=!1;try{for(var p=i(a),b=p.next();!b.done;b=p.next()){var y=b.value;if(this.getAttackablesForField(y,t).includes(e)){d=!0;break}}}catch(t){n={error:t}}finally{try{b&&!b.done&&(r=p.return)&&r.call(p)}finally{if(n)throw n.error}}return d},t.prototype.isCheckmate=function(t,e,o){var i,n,r=e.getHistory().getLastMove();if(!r)return!1;var l=m.convert(r.color),u=t.findKing(l);if(!u)return!1;if(this.isAttacked(t,u,l)&&0===this.getMovablesForField(u,t,e,o).length){var a=t.getFields(),s=0;for(var h in a)for(var f in a[h]){var c=null===(n=null===(i=a[Number(h)])||void 0===i?void 0:i[Number(f)])||void 0===n?void 0:n.getFigure(),g=v.toNotation(Number(h),Number(f));g&&c&&c.getColor()===l&&(s+=this.getMovablesForField(g,t,e,o).length)}if(0===s)return!0}return!1},t}(),G=function(){function t(){this.moves=[]}return t.prototype.pushMove=function(t){this.moves.push(t)},t.prototype.list=function(){return this.moves},t.prototype.filter=function(t){var e=t.color,o=t.name,i=t.startingPosition;return this.moves.filter((function(t){var n=!0;return i&&n&&(n=t.startingPosition===i),o&&n&&(n=t.name===o),e&&n&&(n=t.color===e),n}))},t.prototype.getLastMove=function(){var t;return null!==(t=this.moves[this.moves.length-1])&&void 0!==t?t:null},t.prototype.getMoveCount=function(){return this.moves.length},t}(),J=function(){function t(t,e){this.followablePlan=null!=t?t:{White:[],Black:[]},this.inevitablePlan=null!=e?e:{White:[],Black:[]}}return t.prototype.getNextInevitablePlan=function(t,e){var o;return null!==(o=this.inevitablePlan[null!=t?t:"White"][Math.floor(e/2)])&&void 0!==o?o:null},t.prototype.getNextFollowingPlan=function(t,e){var o;return null!==(o=this.followablePlan[null!=t?t:"White"][Math.floor(e/2)])&&void 0!==o?o:null},t.prototype.listFollowablePlan=function(t,e){return this.followablePlan[null!=t?t:"White"].slice(Math.floor(e/2))},t.prototype.listInevitablePlan=function(t,e){return this.inevitablePlan[null!=t?t:"White"].slice(Math.floor(e/2))},t.prototype.listFollowedPlan=function(t,e){return this.followablePlan[null!=t?t:"White"].slice(0,Math.floor(e/2))},t}(),U=function(){function t(){}return t.convertMoveEventsToRecord=function(t){var e,i,n,r,l,u,a,s,h=o({capture:this.isCapture(t),pawnEnPassant:this.isEnPassant(t),pawnLongMove:this.isPawnLongMove(t),promotion:this.getPromotedFigure(t)},this.isCastle(t)),f=this.extractMainMove(t);return new I([null!==(e=null==f?void 0:f.from)&&void 0!==e?e:null,null!==(i=null==f?void 0:f.to)&&void 0!==i?i:null],{color:null!==(r=null===(n=null==f?void 0:f.figure)||void 0===n?void 0:n.getColor())&&void 0!==r?r:"White",name:null!==(u=null===(l=null==f?void 0:f.figure)||void 0===l?void 0:l.getName())&&void 0!==u?u:"King",startingPosition:null!==(s=null===(a=null==f?void 0:f.figure)||void 0===a?void 0:a.getStartingPosition())&&void 0!==s?s:"a1"},h)},t.isCapture=function(t){return t.filter((function(t){return!t.to})).length>t.filter((function(t){return!t.from})).length},t.getPromotedFigure=function(t){var e,o,i=t.find((function(t){return!t.from}));return null!==(o=null===(e=null==i?void 0:i.figure)||void 0===e?void 0:e.getName())&&void 0!==o?o:null},t.isCastle=function(t){if(2!==t.length)return!1;if(!(1===new Set(t.map((function(t){return t.figure.getColor()}))).size))return!1;var e=t.find((function(t){return"Rook"===t.figure.getName()})),o=t.find((function(t){return"King"===t.figure.getName()}));if(!e||!o)return!1;if(!e.from||!e.to)return!1;var i=n(v.fromNotation(e.from),2)[1],r=n(v.fromNotation(e.to),2)[1];return 2===Math.abs(i-r)?{castleLong:!1,castleShort:!0}:{castleShort:!1,castleLong:!0}},t.isPawnLongMove=function(t){if(1!==t.length)return!1;var e=n(t,1)[0];if(!(null==e?void 0:e.from)||!(null==e?void 0:e.to))return!1;var o=n(v.fromNotation(e.from),1)[0],i=n(v.fromNotation(e.to),1)[0];return 2===Math.abs(o-i)},t.isEnPassant=function(t){if(!t.every((function(t){return"Pawn"===t.figure.getName()}))||2!==t.length)return!1;if(!this.isCapture(t))return!1;var e=t.find((function(t){return!t.to})),o=t.find((function(t){return t.to}));return!(!e||!o)&&e.from!==o.to},t.extractMainMove=function(t){return t.find((function(t){return t.from&&t.to}))},t}(),Z=function(){function t(t){this.history=new G,this.plan=new J(t.data.followablePlan,t.data.inevitablePlan),this.listeners=t.listeners}return t.prototype.getHistory=function(){return this.history},t.prototype.buildMove=function(t){return U.convertMoveEventsToRecord(t)},t.prototype.move=function(t){this.history.pushMove(t)},t.prototype.getNextInevitable=function(){var t=this.history.getLastMove(),e=t?m.convert(t.color):"White";return this.plan.getNextInevitablePlan(e,this.history.getMoveCount())},t.prototype.isFollowingPlan=function(t){var e=this.plan.getNextFollowingPlan(t.color,this.history.getMoveCount());if(!e)return!0;var o=e.equals(t);return o?this.listeners.onPlanContinuance(t,this.plan.listFollowablePlan(t.color,this.history.getMoveCount()+2),this.plan.listFollowedPlan(t.color,this.history.getMoveCount()+2)):this.listeners.onPlanViolation(t,this.plan.listFollowablePlan(t.color,this.history.getMoveCount()),this.plan.listFollowedPlan(t.color,this.history.getMoveCount())),o},t}(),$=function(){function t(t){this.state=null,this.rules=null,this.time=null,this.renderer=null,this.gui=null,this.config=t}return t.prototype.makeState=function(){return this.state?this.state:new Y(this.config.state)},t.prototype.makeRules=function(){return this.rules?this.rules:new D(this.config.rules)},t.prototype.makeTime=function(){return this.time?this.time:new Z(this.config.time)},t.prototype.makeGui=function(t){return this.gui?this.gui:new _(t)},t.prototype.makeRenderer=function(t){return this.renderer?this.renderer:new X(this.config.renderer,t)},t}(),tt=function(t,e){var o=this,i=new $(new V(null!=e?e:{}));this.state=i.makeState(),this.rules=i.makeRules(),this.gui=i.makeGui(t),this.renderer=i.makeRenderer(t),this.time=i.makeTime(),t.onclick=function(e){var i=t.getBoundingClientRect(),n=Math.max(e.clientX-i.left,0),r=Math.max(e.clientY-i.top);o.gui.onClick([n,r],o.state,o.rules,o.time),o.renderer.render(o.state)},this.rules.setup(this.state),this.renderer.render(this.state)},et=function(t){return new(tt.bind.apply(tt,r([void 0],n(t))))};export{et as createBoard};
